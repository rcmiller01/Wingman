services:
  backend:
    image: ${WINGMAN_BACKEND_IMAGE:-ghcr.io/wingmanhq/wingman-backend:latest}
    command: ["sh", "-c", "alembic upgrade head && uvicorn homelab.main:app --host 0.0.0.0 --port 8000"]
    environment:
      DATABASE_URL: postgresql+asyncpg://copilot:${POSTGRES_PASSWORD:-changeme}@postgres:5432/homelab_copilot
      QDRANT_URL: http://qdrant:6333
      EXECUTION_MODE: ${EXECUTION_MODE:-lab}
      WINGMAN_EXECUTION_MODE: ${WINGMAN_EXECUTION_MODE:-lab}
      AUTH_ENABLED: ${AUTH_ENABLED:-true}
      WINGMAN_AUTH_SECRET: ${WINGMAN_AUTH_SECRET:-}
      WINGMAN_CONTAINER_ALLOWLIST: ${WINGMAN_CONTAINER_ALLOWLIST:-}
      WINGMAN_VM_ALLOWLIST: ${WINGMAN_VM_ALLOWLIST:-}
      WINGMAN_NODE_ALLOWLIST: ${WINGMAN_NODE_ALLOWLIST:-}
      WINGMAN_ALLOW_DANGEROUS_OPS: ${WINGMAN_ALLOW_DANGEROUS_OPS:-false}
      WINGMAN_READ_ONLY: ${WINGMAN_READ_ONLY:-false}
      PROXMOX_HOST: ${PROXMOX_HOST:-}
      PROXMOX_USER: ${PROXMOX_USER:-}
      PROXMOX_PASSWORD: ${PROXMOX_PASSWORD:-}
      PROXMOX_TOKEN_NAME: ${PROXMOX_TOKEN_NAME:-}
      PROXMOX_VERIFY_SSL: ${PROXMOX_VERIFY_SSL:-false}
      OLLAMA_HOST: ${OLLAMA_HOST:-http://host.docker.internal:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-qwen2.5:7b}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../knowledge:/app/knowledge
    secrets:
      - wingman_auth_secret
      - proxmox_api_token
      - proxmox_user
      - proxmox_password
      - proxmox_token_name
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health/ready').read()\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - wingman-net

  frontend:
    image: ${WINGMAN_FRONTEND_IMAGE:-ghcr.io/wingmanhq/wingman-frontend:latest}
    environment:
      NEXT_PUBLIC_API_URL: ${PUBLIC_API_URL:-http://localhost:8000}
      INTERNAL_API_URL: http://backend:8000
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/ > /dev/null || wget -qO- http://localhost:3000/ > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - wingman-net

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: copilot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: homelab_copilot
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U copilot -d homelab_copilot"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - wingman-net

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6333/health > /dev/null || wget -qO- http://localhost:6333/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - wingman-net

volumes:
  postgres_data:
  qdrant_data:

secrets:
  wingman_auth_secret:
    file: ./secrets/wingman_auth_secret
  proxmox_api_token:
    file: ./secrets/proxmox_api_token
  proxmox_user:
    file: ./secrets/proxmox_user
  proxmox_password:
    file: ./secrets/proxmox_password
  proxmox_token_name:
    file: ./secrets/proxmox_token_name

networks:
  wingman-net:
    name: wingman-net
